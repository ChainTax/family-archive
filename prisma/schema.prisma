// ─── Generator & Datasource ──────────────────────────────────

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────────────

enum Role {
  OWNER
  EDITOR
  VIEWER
}

enum Visibility {
  PUBLIC
  UNLISTED
  PRIVATE
}

enum PostStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
}

enum MilestoneType {
  BIRTHDAY
  ANNIVERSARY
  GROWTH
  FIRST_EXPERIENCE
  OTHER
}

// ─── User ────────────────────────────────────────────────────
// NextAuth Prisma Adapter 테이블은 Step 2에서 추가

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // bcrypt hash
  name      String?
  role      Role     @default(VIEWER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditLogs AuditLog[]
}

// ─── Post ─────────────────────────────────────────────────────

model Post {
  id          String     @id @default(cuid())
  title       String
  slug        String     @unique
  content     String     @db.Text
  excerpt     String?    @db.Text
  coverUrl    String?
  visibility  Visibility @default(UNLISTED)
  status      PostStatus @default(DRAFT)
  publishedAt DateTime?
  scheduledAt DateTime?
  series      String?

  tags         Tag[]   @relation("PostTags")
  linkedPlaces Place[] @relation("PostPlaces")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, visibility])
  @@index([publishedAt])
  @@index([series])
}

// ─── Album ────────────────────────────────────────────────────

model Album {
  id          String     @id @default(cuid())
  title       String
  slug        String     @unique
  description String?    @db.Text
  dateStart   DateTime?
  dateEnd     DateTime?
  coverUrl    String?
  visibility  Visibility @default(UNLISTED)

  placeId String?
  place   Place?  @relation("AlbumPlace", fields: [placeId], references: [id])

  photos Photo[]
  tags   Tag[]   @relation("AlbumTags")

  linkedPlaces Place[] @relation("AlbumPlaces")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([visibility])
  @@index([dateStart])
}

// ─── Photo ────────────────────────────────────────────────────

model Photo {
  id       String @id @default(cuid())
  albumId  String
  album    Album  @relation(fields: [albumId], references: [id], onDelete: Cascade)

  url      String  // web-optimized WebP (EXIF 제거, public CDN)
  thumbUrl String  // thumbnail WebP (public CDN)
  origKey  String? // original storage key (private bucket, NEVER exposed)

  width   Int
  height  Int
  caption String?
  takenAt DateTime?
  order   Int      @default(0)

  tags Tag[] @relation("PhotoTags")

  createdAt DateTime @default(now())

  @@index([albumId, order])
}

// ─── Place (Map Pin) ─────────────────────────────────────────

model Place {
  id         String     @id @default(cuid())
  name       String
  lat        Float
  lng        Float
  visibility Visibility @default(PUBLIC)

  linkedPosts  Post[]  @relation("PostPlaces")
  linkedAlbums Album[] @relation("AlbumPlaces")
  albums       Album[] @relation("AlbumPlace")

  tags Tag[] @relation("PlaceTags")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([visibility])
}

// ─── Milestone ────────────────────────────────────────────────

model Milestone {
  id         String        @id @default(cuid())
  type       MilestoneType
  title      String
  date       DateTime
  notes      String?       @db.Text
  visibility Visibility    @default(PRIVATE)
  photoIds   String[]      // Photo.id 참조 (경량 연결)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@index([visibility])
}

// ─── Tag ──────────────────────────────────────────────────────

model Tag {
  id   String @id @default(cuid())
  name String @unique

  posts  Post[]  @relation("PostTags")
  albums Album[] @relation("AlbumTags")
  photos Photo[] @relation("PhotoTags")
  places Place[] @relation("PlaceTags")
}

// ─── GuestbookEntry ───────────────────────────────────────────

model GuestbookEntry {
  id        String   @id @default(cuid())
  name      String
  message   String   @db.Text
  approved  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([approved, createdAt])
}

// ─── Audit Log ────────────────────────────────────────────────

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String
  actor      User     @relation(fields: [actorId], references: [id])
  action     String   // CREATE | UPDATE | DELETE | PUBLISH | VISIBILITY_CHANGE
  entityType String   // Post | Album | Photo | Place | Milestone | User
  entityId   String
  diff       Json?    // 변경 전/후 값

  createdAt DateTime @default(now())

  @@index([actorId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ─── GrowthRecord ─────────────────────────────────────────────

model GrowthRecord {
  id         String     @id @default(cuid())
  date       DateTime
  height     Float?
  weight     Float?
  label      String?
  visibility Visibility @default(PRIVATE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@index([visibility])
}
